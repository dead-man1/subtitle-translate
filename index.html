<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitle Translator</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for Browsers -->
    <meta name="theme-color" content="#3b82f6">
    <!-- iOS Specific Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div class="min-h-full flex flex-col">
        <!-- Header with controls -->
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 id="page-title" class="text-2xl font-bold text-primary-600 dark:text-primary-400">Subtitle Translator</h1>
                <div class="flex space-x-3">
                    <button id="languageToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="Toggle language" title="Toggle language (English/Persian)">
                        <i class="fas fa-language text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <button id="clear-memory-button" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="Clear translation memory" title="Clear translation memory">
                        <i class="fa fa-trash text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="Toggle theme" title="Toggle light/dark theme">
                        <i class="fas fa-moon text-gray-600 dark:text-gray-300"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
            <!-- Instructions -->
            <div class="mb-6 text-center">
                <p id="upload-instructions" class="text-lg text-gray-700 dark:text-gray-300">
                    Upload an SRT, VTT, SSA, or ASS file or paste SRT content, provide your Gemini API key, and select the target language.
                </p>
                <p id="text-paste-note" class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                    Note: Pasting text currently only supports the SRT format. For VTT/SSA/ASS, please use file upload.
                </p>
            </div>

            <!-- Warning Message -->
            <div id="warning-message" class="mb-6 p-4 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg text-amber-800 dark:text-amber-200">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle mt-0.5 mr-2 text-amber-500"></i>
                    <span>If in Iran, enable "Use Proxy" in Settings for Gemini API access due to sanctions.</span>
                </div>
            </div>

            <!-- Form -->
            <form id="translate-form" class="space-y-6">
                <!-- Input Method Selection -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                    <label id="input-method-label" class="block text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Input Method:</label>
                    <div class="flex space-x-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="input_method" value="file" checked class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Upload File</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="input_method" value="text" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Paste Text</span>
                        </label>
                    </div>
                </div>

                <!-- File Input Area -->
                <div id="file-input" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                    <label id="file-label" class="block text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Upload Subtitle File (SRT, VTT, SSA, ASS):</label>
                    <div id="dropzone-upload" class="dropzone border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-primary-400 transition-colors">
                        <div class="dz-message">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 dark:text-gray-500 mb-3"></i>
                            <p class="text-gray-600 dark:text-gray-400">Drag & drop SRT/VTT/SSA/ASS file here<br>or click to browse</p>
                        </div>
                    </div>
                </div>

                <!-- Text Input Area -->
                <div id="text-input" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" style="display: none;">
                    <label id="text-label" class="block text-lg font-medium text-gray-900 dark:text-gray-100 mb-3" for="srt_text">Paste SRT Content:</label>
                    <textarea id="srt_text" name="srt_text" rows="6" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="Paste your SRT content here..."></textarea>
                </div>

                <!-- API Key -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                    <label id="api-key-label" class="block text-lg font-medium text-gray-900 dark:text-gray-100 mb-3" for="api_key">Gemini API Key:</label>
                    <div class="relative">
                        <input type="password" id="api_key" name="api_key" class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="Enter your Gemini API key" required>
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300" id="togglePasswordBtn" aria-label="Toggle API key visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="mt-3 flex items-center">
                        <input type="checkbox" id="remember_me" name="remember_me" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                        <label id="remember-me-label" for="remember_me" class="ml-2 text-gray-700 dark:text-gray-300">Remember API key</label>
                    </div>
                    <p id="api-key-note" class="mt-2 text-sm text-gray-500 dark:text-gray-400">Get your API key from <a href='https://aistudio.google.com/app/apikey' target='_blank' class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">Google AI Studio</a>.</p>
                </div>

                <!-- Target Language -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                    <label id="lang-label" class="block text-lg font-medium text-gray-900 dark:text-gray-100 mb-3" for="lang-input">Target Language:</label>
                    <input type="text" id="lang-input" name="lang" value="Persian (Farsi)" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., Spanish, French, Japanese" required>
                </div>

                <!-- Advanced Settings -->
                <details class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                    <summary class="flex items-center justify-between cursor-pointer list-none">
                        <span id="advanced-settings-summary-text" class="text-lg font-medium text-gray-900 dark:text-gray-100">Advanced Settings</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-300"></i>
                    </summary>
                    <div class="mt-6 space-y-6">
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg text-amber-800 dark:text-amber-200">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle mt-0.5 mr-2 text-amber-500"></i>
                                <span>Adjusting these settings can affect performance, cost, and translation quality. Proceed with caution.</span>
                            </div>
                        </div>

                        <div>
                            <label id="model-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="model">Gemini Model:</label>
                            <select id="model" name="model" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100">
                                <option value="gemini-2.5-flash-preview-04-17">Gemini 2.5 Flash</option>
                                <option value="gemini-2.0-flash" selected>Gemini 2.0 Flash</option>
                                <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite</option>
                                <option value="gemini-2.5-pro-preview-03-25">Gemini 2.5 Pro</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash-8B</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                            </select>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Select the AI model for translation.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label id="temperature-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="temperature">Temperature:</label>
                                <input type="number" id="temperature" name="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 0.7">
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Controls randomness (0.0-2.0). Higher values = more creative/random.</p>
                            </div>

                            <div>
                                <label id="top-p-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="top_p">Top-P:</label>
                                <input type="number" id="top_p" name="top_p" min="0" max="1" step="0.05" value="0.95" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 0.95">
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Nucleus sampling (0.0-1.0). Considers tokens comprising the top P probability mass.</p>
                            </div>

                            <div>
                                <label id="top-k-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="top_k">Top-K:</label>
                                <input type="number" id="top_k" name="top_k" min="1" step="1" value="40" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 40">
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Sample from the K most likely tokens (integer >= 1).</p>
                            </div>

                            <div>
                                <label id="max-output-tokens-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="max_output_tokens">Max Output Tokens:</label>
                                <input type="number" id="max_output_tokens" name="max_output_tokens" min="1" step="1" value="8192" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 8192">
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Maximum number of tokens to generate per request (check model limits).</p>
                            </div>
                        </div>

                        <div>
                            <label id="stop-sequences-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="stop_sequences">Stop Sequences (comma-separated):</label>
                            <input type="text" id="stop_sequences" name="stop_sequences" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., END, ---">
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Stop generation if these strings appear. Leave blank if none.</p>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="useProxyCheckbox" name="useProxyCheckbox" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                <label id="use-proxy-label" for="useProxyCheckbox" class="ml-2 text-gray-700 dark:text-gray-300">Use Proxy</label>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Enable if direct Gemini API access is blocked (e.g., sanctioned regions).</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label id="base-delay-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="base_delay">Base Delay (ms):</label>
                                    <input type="number" id="base_delay" name="base_delay" min="100" value="1000" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="1000" required>
                                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Delay between successful chunk requests.</p>
                                </div>

                                <div>
                                    <label id="quota-delay-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="quota_delay">Quota Delay (ms):</label>
                                    <input type="number" id="quota_delay" name="quota_delay" min="1000" value="60000" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="60000" required>
                                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Delay after hitting a rate limit (429 error).</p>
                                </div>

                                <div>
                                    <label id="chunk-count-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="chunk_count">Number of Chunks:</label>
                                    <input type="number" id="chunk_count" name="chunk_count" min="1" max="100" value="20" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100" placeholder="20" required>
                                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Split SRT into this many parts (1-100).</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label id="translation-prompt-label" class="block text-sm font-medium text-gray-900 dark:text-gray-100 mb-1" for="translation_prompt">System Prompt / Instructions:</label>
                            <textarea id="translation_prompt" name="translation_prompt" rows="5" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-gray-100">Translate the following subtitle text into the target language. Maintain the original meaning, natural conversational tone, and appropriate length for subtitles. Respond ONLY with the translated text lines, separated by `---`.</textarea>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Instructions for the AI model.</p>
                        </div>
                    </div>
                </details>

                <!-- Submit Button -->
                <div class="flex justify-center">
                    <button id="submit-button" type="submit" class="px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-md transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
                        <span class="button-text">Translate</span>
                        <span class="shortcut-hint ml-2 text-sm opacity-80">(Ctrl+Enter)</span>
                    </button>
                </div>
            </form>

            <!-- Progress Display -->
            <div id="progress-container" class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm" style="display: none;">
                <div class="mb-4">
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress" class="bg-primary-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                    <div id="progress-text">0% Complete</div>
                    <div id="time-estimate">Estimated time: calculating...</div>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <span id="chunk-status">Processing chunk: 0/0</span>
                </div>
            </div>

            <!-- Download Link Area -->
            <div id="download-link" class="mt-6"></div>

            <!-- Error Message Area -->
            <div id="error-message" class="mt-6 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg text-red-800 dark:text-red-200" style="display: none;">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-circle mt-0.5 mr-2 text-red-500"></i>
                    <span></span>
                </div>
            </div>
        </main>

        <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-gray-600 dark:text-gray-400">ساخته شده با ❤️ توسط <a href="https://x.com/yebekhe" target="_blank" rel="noopener noreferrer" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">yebekhe</a></p>
                    <!-- English version (will be swapped by JS) -->
                    <p style="display: none;" class="text-gray-600 dark:text-gray-400">Created with ❤️ by <a href="https://x.com/yebekhe" target="_blank" rel="noopener noreferrer" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">yebekhe</a></p>
                    <div class="donate-section mt-4 md:mt-0">
                        <a href="https://plisio.net/donate/9mF8kcrb" target="_blank" rel="noopener noreferrer" class="donate-button px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors duration-300" id="donateButton">
                            <!-- Text will be set by JS -->
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Dropzone JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
    <!-- Link to your custom JavaScript -->
    <script src="assets/script.js"></script>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swPath = '/subtitle-translate/sw.js';
                navigator.serviceWorker.register(swPath)
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        } else {
             console.log('Service Worker not supported in this browser.');
        }
    </script>
</body>
</html>
